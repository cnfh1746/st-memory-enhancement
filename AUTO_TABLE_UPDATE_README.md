# 自动填表功能文档

## 概述

自动填表功能是一个全新的表格更新模式，旨在提供比分步填表更智能、更高效的自动化表格更新体验。该功能在后台自动处理表格更新，无需用户手动干预。

## 核心特性

### 1. **智能批量处理**
- 支持批量处理多个表格，可配置每次处理1-10个表格
- 自动按优先级排序（required表格优先）
- 支持失败重试机制（最多3次）

### 2. **上下文智能管理**
- 自动提取最近的N条消息作为更新依据
- 可选包含系统消息和角色卡信息
- 智能过滤和格式化上下文内容

### 3. **灵活的API配置**
- 支持使用主API或独立API
- 复用分步填表的API配置
- 支持温度、模型等参数自定义

### 4. **静默模式**
- 可选开启静默处理，不显示进度提示
- 后台自动完成，不打断用户体验

## 工作流程

```
用户发送消息 
    ↓
AI回复完成
    ↓
触发自动填表监听器
    ↓
检查是否启用自动填表
    ↓
获取当前所有启用的表格
    ↓
批量分组处理（每组N个表格）
    ↓
为每个表格构建更新提示词
    ↓
调用LLM API生成更新指令
    ↓
解析并执行更新指令
    ↓
保存更新后的表格数据
    ↓
更新系统消息中的表格状态
```

## 配置选项

### 基础设置
- **启用自动填表**: `auto_table_update_enabled` (boolean)
- **使用主API**: `auto_update_use_main_api` (boolean, 默认: true)
- **批量处理数量**: `auto_update_batch_size` (number, 1-10, 默认: 3)
- **上下文消息数**: `auto_update_context_messages` (number, 1-50, 默认: 10)
- **包含系统消息**: `auto_update_include_system` (boolean, 默认: false)
- **静默模式**: `auto_update_silent_mode` (boolean, 默认: true)

### API配置
当未使用主API时，会复用分步填表的API配置：
- API URL
- API Key
- Model Name
- Temperature

## 使用方法

### 1. 启用自动填表

在插件设置中：
1. 找到"填表行为发生在"下拉框
2. 选择"自动填表（后台自动）"
3. 配置相关参数

### 2. 配置参数

**推荐配置**：
```
批量处理数量: 3-5个
上下文消息数: 10-15条
包含系统消息: 否（除非需要角色信息）
静默模式: 是（不打断体验）
使用主API: 是（性能更好）
```

**高负载场景**：
```
批量处理数量: 1-2个
上下文消息数: 5-8条
静默模式: 否（观察处理进度）
```

### 3. 监控和调试

- 开启调试模式可查看详细处理日志
- 控制台会输出每个批次的处理状态
- 失败的表格会自动重试

## 与其他模式的对比

| 特性 | 同步填表 | 分步填表 | 自动填表 |
|------|---------|---------|---------|
| 触发时机 | 聊天时 | 手动/自动 | 自动 |
| 用户干预 | 无 | 需确认 | 无 |
| 批量处理 | 否 | 否 | 是 |
| 上下文管理 | 基础 | 高级 | 智能 |
| 性能影响 | 高 | 中 | 低 |
| 适用场景 | 简单表格 | 复杂表格 | 多表格自动化 |

## 技术实现

### 核心模块
- **autoTableUpdate.js**: 主要实现文件
  - `processAutoTableUpdate()`: 核心处理函数
  - `buildAutoUpdatePrompt()`: 构建更新提示词
  - `extractTableUpdateActions()`: 提取更新指令
  - `executeBatchUpdate()`: 批量执行更新

### 集成点
- **index.js**: 主入口集成
  - 初始化自动填表设置
  - 注册事件监听器
  - 调整提示词注入逻辑（只读模式）

- **userExtensionSetting.js**: 设置界面
  - 添加UI控件
  - 绑定事件处理
  - 保存/加载配置

## 注意事项

1. **提示词注入变化**
   - 自动填表模式下，只注入只读表格数据
   - 不包含填表说明，避免AI混淆
   - 确保AI专注于对话，表格由后台处理

2. **性能考虑**
   - 批量处理数量不宜过大（建议≤5）
   - 上下文消息数根据模型能力调整
   - 大量表格建议分批启用

3. **错误处理**
   - 失败的表格会自动重试（最多3次）
   - 重试后仍失败会在控制台记录
   - 不会阻塞其他表格的处理

4. **兼容性**
   - 与分步填表互斥（只能选一个）
   - 与同步填表互斥
   - 可与独立API模式共存

## 故障排查

### 问题：自动填表不工作
- 检查是否正确选择"自动填表"模式
- 确认表格已启用（enable = true）
- 查看控制台是否有错误日志

### 问题：更新不准确
- 增加上下文消息数量
- 开启"包含系统消息"选项
- 检查表格提示词是否清晰

### 问题：性能问题
- 减少批量处理数量
- 减少上下文消息数
- 启用静默模式

### 问题：API调用失败
- 检查API配置是否正确
- 验证API Key是否有效
- 尝试使用主API

## 未来改进方向

1. **增量更新优化**
   - 只更新变化的单元格
   - 减少不必要的API调用

2. **智能调度**
   - 根据表格重要性动态调整优先级
   - 智能延迟非紧急表格的更新

3. **更多配置选项**
   - 自定义重试策略
   - 表格级别的配置覆盖
   - 更新频率控制

4. **统计和监控**
   - 更新成功率统计
   - API调用成本追踪
   - 性能指标面板

## 版本历史

### v1.0.0 (2025-01-19)
- 初始版本发布
- 实现基础自动填表功能
- 支持批量处理和智能重试
- 集成到主插件系统

---

**作者**: Cline  
**最后更新**: 2025-01-19  
**插件版本**: 2.2.0+
