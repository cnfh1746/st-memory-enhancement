# 自动填表调试指南

## 🔍 问题诊断

现在已经添加了超详细的调试日志，可以精确定位问题出现在哪一步。

## 📋 测试步骤

### 1. 重新加载插件
- 刷新 SillyTavern 页面
- 打开浏览器控制台 (F12)

### 2. 检查初始化日志

在控制台中查找以下日志：

```
[自动填表] ========================================
[自动填表] 开始注册自动填表监听器
[自动填表] ========================================
[自动填表] ✅ APP 对象存在
[自动填表] ✅ APP.eventSource 存在
[自动填表] ✅ APP.event_types 存在
[自动填表] ✅ MESSAGE_RECEIVED 事件类型存在
[自动填表] 当前配置: {...}
[自动填表] ========================================
[自动填表] ✅✅✅ 监听器注册成功！✅✅✅
[自动填表] ========================================
```

**如果看到上述日志** ✅ - 监听器注册成功

**如果看到错误日志** ❌ - 例如：
- `❌ APP 对象不存在！`
- `❌ APP.eventSource 不存在！`
- `❌ MESSAGE_RECEIVED 事件类型不存在！`

这表明初始化阶段出现问题。

### 3. 测试触发

#### 3.1 启用自动填表功能
1. 打开插件设置
2. 找到"自动表格更新"部分
3. 启用"启用自动填表"选项
4. 配置独立API或选择使用主API

#### 3.2 发送测试消息
1. 向AI发送一条消息
2. 等待AI回复
3. **立即查看控制台**

### 4. 查看详细日志

AI回复后，你应该看到类似这样的日志序列：

```
[自动填表 08:20:15.123] ========================================
[自动填表 08:20:15.123] ⚡⚡⚡ MESSAGE_RECEIVED 事件触发！⚡⚡⚡
[自动填表 08:20:15.123] ========================================
[自动填表 08:20:15.124] 接收到的 chatId: 5
[自动填表 08:20:15.124] [步骤1] 检查功能是否启用...
[自动填表 08:20:15.124] [步骤1] 功能启用状态: true
[自动填表 08:20:15.125] [步骤2] 检查处理状态...
[自动填表 08:20:15.125] [步骤3] 获取聊天上下文...
[自动填表 08:20:15.125] [步骤3] 聊天长度: 6
[自动填表 08:20:15.126] [步骤4] 获取最新消息...
[自动填表 08:20:15.126] [步骤4] 最新消息信息: {is_user: false, name: "角色名", ...}
[自动填表 08:20:15.127] [步骤5] ✅ 这是AI消息，继续处理
[自动填表 08:20:15.127] [步骤6] 检查消息长度...
[自动填表 08:20:15.127] [步骤6] 消息长度: 150 最小要求: 50
[自动填表 08:20:15.128] [步骤7] ✅ 所有检查通过，开始处理自动填表
[自动填表 08:20:15.128] ========================================
[自动填表 08:20:15.129] [处理] 开始自动填表流程
[自动填表 08:20:15.130] [处理] 获取当前表格数据...
[自动填表 08:20:15.131] [处理] 当前表格数据长度: 500
... 更多日志 ...
```

## 🎯 问题定位

### 情况A：完全没有日志
**症状：** 刷新页面后，控制台没有任何 `[自动填表]` 相关日志

**可能原因：**
1. 模块导入失败
2. index.js 中的初始化代码未执行

**解决方案：**
- 检查浏览器控制台是否有 JavaScript 错误
- 确认文件路径正确

### 情况B：只有初始化日志，没有触发日志
**症状：** 能看到"监听器注册成功"，但AI回复后没有"MESSAGE_RECEIVED 事件触发"

**可能原因：**
1. 事件监听器没有正确绑定
2. 事件类型不匹配

**解决方案：**
- 查看日志中显示的 `MESSAGE_RECEIVED` 事件类型的值
- 确认是否与参考项目一致

### 情况C：触发了但在某步骤退出
**症状：** 能看到"MESSAGE_RECEIVED 事件触发"，但在某个步骤后停止

**示例日志：**
```
[自动填表] [步骤1] 功能启用状态: false
[自动填表] [步骤1] ⏸️ 自动填表功能未启用，退出
```

**解决方案：**
- 根据日志提示，检查对应的配置项
- 步骤1退出：检查是否启用了自动填表
- 步骤5退出：消息是用户消息，这是正常的
- 步骤6退出：消息太短，调整最小长度设置

### 情况D：API调用失败
**症状：** 能到达"发送分析请求到API"步骤，但之后报错

**查看：**
- `[处理] API响应长度: 0` - API未返回内容
- 错误堆栈信息

**解决方案：**
- 检查API配置是否正确
- 检查API密钥是否有效
- 查看网络请求是否成功

## 🔧 手动测试

在浏览器控制台中运行以下命令进行手动测试：

```javascript
// 检查监听器是否注册
console.log('事件监听器状态:', APP.eventSource._events[APP.event_types.MESSAGE_RECEIVED]);

// 检查配置
console.log('自动填表配置:', {
    enabled: USER.tableBaseSetting.auto_table_update_enabled,
    useMainAPI: USER.tableBaseSetting.auto_update_use_main_api,
    silentMode: USER.tableBaseSetting.auto_update_silent_mode
});

// 手动触发（需要有AI消息）
// 注意：这需要导入模块，可能在控制台不可用
```

## 📊 关键配置项

检查 `USER.tableBaseSetting` 中的这些配置：

```javascript
{
    "auto_table_update_enabled": true,        // 必须为 true
    "auto_update_use_main_api": false,        // true=主API, false=独立API
    "auto_update_silent_mode": false,         // true=静默模式，不显示提示
    "auto_update_min_message_length": 50,     // 最小消息长度
    "auto_update_prompt_template": "..."      // 提示词模板
}
```

## 📝 报告问题时请提供

1. **初始化日志** - 从"开始注册"到"监听器注册成功"的完整日志
2. **触发日志** - AI回复后的完整日志序列
3. **配置信息** - 自动填表相关的配置项
4. **错误信息** - 如果有错误，完整的错误堆栈

## 🎨 与参考项目的对比

参考项目 (Amily2) 的关键特点：

1. ✅ 使用 `MESSAGE_RECEIVED` 事件
2. ✅ 事件处理函数接收 `chatId` 参数
3. ✅ 在处理函数内部检查配置和消息类型
4. ✅ 使用独立的API调用进行表格分析

我们的实现已经完全遵循了这些特点。

## 🚀 下一步

如果所有日志都正常，但表格仍未更新，可能是：
1. API返回的指令格式不正确
2. 表格操作执行失败
3. 保存逻辑有问题

根据日志中的具体输出来进一步诊断。
